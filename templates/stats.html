<!DOCTYPE html>
<html>
<head>
    <title>Analytics</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            /* –ë–∞–∑–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ (–±—É–¥—É—Ç –º–µ–Ω—è—Ç—å—Å—è JS-–æ–º) */
            --bg-color: var(--tg-theme-secondary-bg-color, #f0f0f6);
            --card-bg: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #000000);
            --accent: var(--tg-theme-button-color, #007aff);
            --green: #34c759;
            --red: #ff3b30;
            --border: rgba(0,0,0,0.1);
        }

        /* –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê (–∫–ª–∞—Å—Å –≤–µ—à–∞–µ—Ç—Å—è JS-–æ–º) */
        body.dark-mode {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --text-color: #ffffff;
            --border: rgba(255,255,255,0.15);
        }
        /* –°–í–ï–¢–õ–ê–Ø –¢–ï–ú–ê */
        body.light-mode {
            --bg-color: #f2f2f7;
            --card-bg: #ffffff;
            --text-color: #000000;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: 16px; transition: background 0.3s, color 0.3s;
        }
        
        .header { display: flex; align-items: center; margin-bottom: 20px; }
        .back-link { 
            color: var(--accent); text-decoration: none; font-size: 17px; 
            font-weight: 500; display: flex; align-items: center;
        }

        /* FILTER SECTION */
        .filter-card {
            background: var(--card-bg); border-radius: 12px; padding: 15px;
            margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .filter-row { display: flex; gap: 10px; margin-bottom: 10px; }
        select {
            flex: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--border);
            background: var(--bg-color); color: var(--text-color); font-size: 16px; outline: none;
        }
        
        /* Segmented Control */
        .segmented-control {
            display: flex; background: var(--bg-color); padding: 3px; 
            border-radius: 9px; width: 100%;
        }
        .segment-btn {
            flex: 1; text-align: center; padding: 6px; font-size: 13px;
            text-decoration: none; color: var(--text-color); border-radius: 7px;
            opacity: 0.6; transition: all 0.2s;
        }
        .segment-btn.active {
            background: var(--card-bg); opacity: 1; font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* DASHBOARD */
        .chart-box {
            text-align: center; margin: 30px 0;
        }
        .percentage-big {
            font-size: 48px; font-weight: 800; color: var(--accent);
            display: block; margin-bottom: 5px;
        }
        .sub-text { opacity: 0.6; font-size: 14px; text-transform: uppercase; }

        .bar-container {
            height: 8px; background: var(--bg-color); border-radius: 4px;
            overflow: hidden; margin: 10px 0 20px 0; display: flex;
        }
        .bar-fill-green { background: var(--green); height: 100%; }
        .bar-fill-red { background: var(--red); height: 100%; }

        .stats-grid { display: flex; gap: 10px; }
        .stat-mini {
            flex: 1; background: var(--card-bg); padding: 15px; border-radius: 12px;
            text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stat-mini b { font-size: 20px; display: block; }
        .stat-mini span { font-size: 12px; opacity: 0.6; }

        /* SETTINGS SECTION */
        h3 { margin-top: 30px; margin-bottom: 10px; margin-left: 5px; opacity: 0.5; font-size: 13px; text-transform: uppercase; }
        .settings-list { background: var(--card-bg); border-radius: 12px; overflow: hidden; }
        .setting-item {
            padding: 15px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .setting-item:last-child { border-bottom: none; }
        
        .theme-btns button {
            background: var(--bg-color); border: none; padding: 5px 10px;
            border-radius: 6px; cursor: pointer; color: var(--text-color);
        }
        .danger-btn { color: var(--red); background: none; border: none; font-size: 16px; cursor: pointer; width: 100%; text-align: left; padding: 0;}

        /* MODAL (Password) */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-box {
            background: var(--card-bg); padding: 20px; border-radius: 16px; width: 80%; text-align: center;
        }
        .modal input { width: 90%; padding: 10px; margin: 15px 0; font-size: 18px; text-align: center; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-color); color: var(--text-color);}
    </style>
</head>
<body>
    <div class="header">
        <a href="/" class="back-link">‚Üê –ù–∞–∑–∞–¥</a>
        <h2 style="margin: 0 0 0 15px; font-size: 20px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
    </div>

    <div class="filter-card">
        <form id="filterForm" method="get" action="/stats">
            <div class="filter-row">
                <select name="cat_filter" onchange="this.form.submit()">
                    <option value="all" {% if cat_filter == 'all' %}selected{% endif %}>–í—Å–µ –±–ª–æ–∫–∏</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if cat_filter == cat.id|string %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="segmented-control">
                <a href="/stats?period=week&cat_filter={{ cat_filter }}" class="segment-btn {% if period == 'week' %}active{% endif %}">–ù–µ–¥–µ–ª—è</a>
                <a href="/stats?period=month&cat_filter={{ cat_filter }}" class="segment-btn {% if period == 'month' %}active{% endif %}">–ú–µ—Å—è—Ü</a>
                <a href="/stats?period=all&cat_filter={{ cat_filter }}" class="segment-btn {% if period == 'all' %}active{% endif %}">–í—Å—ë –≤—Ä–µ–º—è</a>
            </div>
        </form>
    </div>

    <div class="chart-box">
        <span class="sub-text">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ({{ selected_cat_name }})</span>
        <span class="percentage-big">{{ efficiency }}%</span>
        
        <div class="bar-container">
            <div class="bar-fill-green" style="width: {{ efficiency }}%"></div>
            <div class="bar-fill-red" style="width: {{ 100 - efficiency }}%"></div>
        </div>

        <div class="stats-grid">
            <div class="stat-mini">
                <b class="green">{{ completed }}</b>
                <span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
            </div>
            <div class="stat-mini">
                <b class="red">{{ expired }}</b>
                <span>–°–≥–æ—Ä–µ–ª–æ</span>
            </div>
        </div>
    </div>

    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
    <div class="settings-list">
        <div class="setting-item">
            <span>–¢–µ–º–∞</span>
            <div class="theme-btns">
                <button onclick="setTheme('auto')">Auto</button>
                <button onclick="setTheme('light')">‚òÄÔ∏è</button>
                <button onclick="setTheme('dark')">üåô</button>
            </div>
        </div>
        <div class="setting-item">
            <button class="danger-btn" onclick="openResetModal()">–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        </div>
    </div>

    <div id="resetModal" class="modal">
        <div class="modal-box">
            <h3>–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö</h3>
            <p style="font-size: 13px; opacity: 0.7">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞ (1234) –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–¥–∞—á.</p>
            <form action="/reset-data" method="post">
                <input type="password" name="password" placeholder="–ö–æ–¥" required>
                <div style="display: flex; gap: 10px;">
                    <button type="button" onclick="closeResetModal()" style="flex:1; padding: 10px; border:none; background: transparent; color: var(--accent);">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" style="flex:1; padding: 10px; border:none; background: var(--red); color: white; border-radius: 8px;">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        Telegram.WebApp.ready();

        // --- –õ–û–ì–ò–ö–ê –¢–ï–ú–´ ---
        function setTheme(mode) {
            document.body.classList.remove('dark-mode', 'light-mode');
            if (mode === 'dark') {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else if (mode === 'light') {
                document.body.classList.add('light-mode');
                localStorage.setItem('theme', 'light');
            } else {
                localStorage.removeItem('theme'); // Auto
            }
        }

        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            setTheme(savedTheme);
        } else {
            // –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ—Ç, –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—É—é —Ç–µ–º—É —Ç–µ–ª–µ–≥—Ä–∞–º
            if (Telegram.WebApp.colorScheme === 'dark') {
                setTheme('dark');
            }
        }

        // --- –õ–û–ì–ò–ö–ê –ú–û–î–ê–õ–ö–ò ---
        function openResetModal() { document.getElementById('resetModal').style.display = 'flex'; }
        function closeResetModal() { document.getElementById('resetModal').style.display = 'none'; }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ URL –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ —Å–±—Ä–æ—Å–∞
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('reset') === 'error') {
            Telegram.WebApp.showAlert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
        } else if (urlParams.get('reset') === 'success') {
            Telegram.WebApp.showAlert("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–∏—â–µ–Ω–∞.");
        }
    </script>
</body>
</html>